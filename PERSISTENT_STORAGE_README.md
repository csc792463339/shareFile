# 文件分享应用 - 持久化存储功能

## 新功能概述

本次更新为文件分享应用添加了持久化存储功能，确保应用重启后分享记录不会丢失。

## 主要改进

### 1. 持久化存储
- **双重存储策略**: 同时使用内存缓存(Caffeine)和文件存储(JSON)
- **高性能**: 读取优先从内存缓存获取，保证性能不下降
- **异步写入**: 使用单独线程池异步写入磁盘，不影响主业务性能
- **原子性操作**: 使用临时文件+原子移动确保数据完整性

### 2. 数据安全
- **读写锁**: 保证并发访问时的数据一致性
- **优雅关闭**: 应用关闭时自动保存所有数据
- **过期清理**: 自动清理过期数据，避免文件过大

### 3. 配置说明

#### application.yml 配置
```yaml
app:
  storage:
    # 元数据文件路径（可选，默认: ./data/shares_metadata.json）
    metadata-file: ./data/shares_metadata.json
```

### 4. 技术实现

#### 核心组件
- **PersistentTextStorage**: 新的持久化存储服务
- **MemoryTextStorage**: 保留原有内存存储（用于向后兼容）
- **StorageMigrationTool**: 数据迁移工具（可选）

#### 性能特性
- **内存优先**: 读取操作优先访问内存缓存
- **批量写入**: 30秒间隔批量写入磁盘
- **懒加载**: 启动时快速加载有效数据
- **锁粒度优化**: 使用读写锁最小化锁竞争

### 5. 使用方式

应用启动后会自动：
1. 创建存储目录（`./data/`）
2. 加载已有的分享记录
3. 启动后台写入任务
4. 应用关闭时保存所有数据

### 6. 文件结构

```
data/
  shares_metadata.json          # 分享记录元数据
  shares_metadata.json.tmp      # 临时文件（写入时使用）
```

### 7. 监控和日志

应用会记录以下关键操作：
- 数据加载情况
- 写入操作状态  
- 过期数据清理
- 错误恢复情况

### 8. 容灾和恢复

- **故障恢复**: 如果元数据文件损坏，应用会从空状态启动
- **数据备份**: 建议定期备份 `data/` 目录
- **版本兼容**: 向后兼容，可以安全升级

## 性能影响

- **读取性能**: 无影响（仍然是内存访问）
- **写入性能**: 轻微影响（异步操作，影响极小）
- **内存使用**: 基本无变化
- **磁盘使用**: 新增元数据文件（通常 < 1MB）

## 注意事项

1. 确保应用对 `data/` 目录有读写权限
2. 在生产环境中建议定期备份数据目录
3. 如需迁移现有内存数据，可启用迁移工具

## 故障排除

### 常见问题

1. **权限错误**: 检查应用对数据目录的读写权限
2. **磁盘空间**: 确保有足够的磁盘空间
3. **文件锁定**: 确保没有其他进程占用元数据文件

### 日志查看

查看应用日志中包含 "持久化" 关键字的信息：
```bash
grep "持久化" application.log
```
